<analysis>**original_problem_statement:**
Build a complete mobile-first CRM mini-ERP web application for SUNSTORE KOLHAPUR. The application must be stabilized for production use by addressing critical bugs, improving mobile usability, and implementing several UI/UX enhancements.

**PRODUCT REQUIREMENTS:**
- **Phase 1: Lock Critical Logic:**
    - Solidify GST calculation logic across the entire application (UI, PDF, conversions) to be non-regressive.
    - Fix a critical bug causing incorrect party/item data in generated PDFs.
    - Implement a new, robust PDF file naming convention: .
- **Phase 2: Mobile Usability:**
    - Rework Party and Item selection on forms to use a full-screen modal/bottom sheet for a better mobile experience.
    - Enhance the item selection modal with improved multi-field filtering and clearer display of item details.
    - Add Quick Create buttons for Parties and Items directly within the selection modals.
    - Implement a Duplicate Item feature on document forms to speed up data entry.
- **Phase 3: UI Polish & Clarity:**
    - Add a toggle for Grid View and List View on all document listing pages.
    - Display the first 5 letters of the Party Name on document list cards/rows for easy identification.
    - Decouple the Lead creation form from the Party Master, allowing for free-text entry of party details.
- **Phase 4: PDF Layout Lock:**
    - Finalize and enforce a clean, well-spaced, and consistent PDF layout for Quotations, PIs, and SOAs.
- **Phase 5: General Quality Controls:**
    - Ensure data consistency between saved documents, UI previews, and generated PDFs, eliminating stale data issues.

**User's preferred language**: English

**what currently exists?**
A full-stack CRM application (React, FastAPI, MongoDB) with user authentication, role-based access, and CRUD operations for Leads, Parties, Items, Quotations, Proforma Invoices (PI), and Sales Order Acknowledgements (SOA). The app features a dashboard, PDF generation, and document conversion workflows.

The agent has already implemented significant changes from a large user request, including:
- Locking down the backend GST logic and PDF file naming convention (Phase 1).
- Creating new mobile-first modal components (, , , , ).
- Decoupling the Lead form and backend model from the Party master (Phase 3).
- Partially implementing the new mobile modals and Duplicate Item feature on the  and .
- Partially implementing the Grid/List view toggle and Party Name display on .

**Last working item**:
- **Last item agent was working:** The agent was in the middle of a large, multi-phase feature implementation and stabilization task. It had just updated  with the new mobile-first modals and was about to perform similar updates to  and the remaining document list pages.
- **Status:** IN PROGRESS
- **Agent Testing Done:** N
- **Which testing method agent to use?** Frontend testing agent. The scope of changes is very large, affecting core workflows on multiple pages (document forms and lists) and introducing several new components. A comprehensive end-to-end test is required after the implementation is complete.
- **User Testing Done:** N

**All Pending/In progress Issue list**:
- **Issue 1: Recurring Backend Crash (P0)**
    - **Description:** The backend server crashes frequently due to a missing WeasyPrint system dependency (). This is a critical environmental issue that blocks all development and testing when it occurs.
    - **Status:** RECURRING
- **Issue 2: User Login Failures (P1)**
    - **Description:** Users have repeatedly been unable to log in, especially after backend crashes or user data modifications. This often requires the agent to fix the backend and/or reset passwords.
    - **Status:** RECURRING

**Issues Detail:**
- **Issue 1: Recurring backend crash due to WeasyPrint dependency**
    - **Attempted fixes:** The agent has successfully fixed this multiple times by reinstalling the required library. This is a known workaround.
    - **Next debug checklist:**
        1. Check backend logs for .
        2. Execute: Hit:1 http://deb.debian.org/debian bookworm InRelease
Get:2 http://deb.debian.org/debian bookworm-updates InRelease [55.4 kB]
Get:3 http://deb.debian.org/debian-security bookworm-security InRelease [48.0 kB]
Hit:4 https://deb.nodesource.com/node_20.x nodistro InRelease
Get:5 https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/7.0 InRelease [3001 B]
Get:6 http://deb.debian.org/debian-security bookworm-security/main arm64 Packages [286 kB]
Get:7 https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/7.0/multiverse amd64 Packages [99.1 kB]
Get:8 https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/7.0/multiverse arm64 Packages [97.8 kB]
Fetched 589 kB in 2s (295 kB/s)
Reading package lists...
Reading package lists...
Building dependency tree...
Reading state information...
libpango-1.0-0 is already the newest version (1.50.12+ds-1).
The following NEW packages will be installed:
  libpangoft2-1.0-0
0 upgraded, 1 newly installed, 0 to remove and 1 not upgraded.
Need to get 44.5 kB of archives.
After this operation, 178 kB of additional disk space will be used.
Get:1 http://deb.debian.org/debian bookworm/main arm64 libpangoft2-1.0-0 arm64 1.50.12+ds-1 [44.5 kB]
Fetched 44.5 kB in 0s (594 kB/s)
Selecting previously unselected package libpangoft2-1.0-0:arm64.
(Reading database ... (Reading database ... 5%(Reading database ... 10%(Reading database ... 15%(Reading database ... 20%(Reading database ... 25%(Reading database ... 30%(Reading database ... 35%(Reading database ... 40%(Reading database ... 45%(Reading database ... 50%(Reading database ... 55%(Reading database ... 60%(Reading database ... 65%(Reading database ... 70%(Reading database ... 75%(Reading database ... 80%(Reading database ... 85%(Reading database ... 90%(Reading database ... 95%(Reading database ... 100%(Reading database ... 38353 files and directories currently installed.)
Preparing to unpack .../libpangoft2-1.0-0_1.50.12+ds-1_arm64.deb ...
Unpacking libpangoft2-1.0-0:arm64 (1.50.12+ds-1) ...
Setting up libpangoft2-1.0-0:arm64 (1.50.12+ds-1) ...
Processing triggers for libc-bin (2.36-9+deb12u13) ...
        3. Restart the backend service: backend: stopped
backend: started.
    - **Why fix this issue and what will be achieved with the fix?** The backend becomes operational, unblocking all further development and testing.
    - **Status:** RECURRING
    - **Is recurring issue?** Y
    - **Should Test frontend/backend/both after fix?** Backend (confirm login API works with ).
    - **Blocked on other issue:** None.
- **Issue 2: User Login Failures**
    - **Attempted fixes:** Resetting user passwords via a Python script; fixing the WeasyPrint dependency crash which was the root cause.
    - **Next debug checklist:**
        1. First, check for the WeasyPrint crash (Issue 1).
        2. If the backend is running, verify user credentials in the database.
        3. If necessary, run a script to reset the password hash for the affected user.
    - **Why fix this issue and what will be achieved with the fix?** Allows the user and agent to access and test the application.
    - **Status:** RECURRING
    - **Is recurring issue?** Y
    - **Should Test frontend/backend/both after fix?** Backend.
    - **Blocked on other issue:** Often blocked by Issue 1.

**In progress Task List**:
- **Task 1: Complete Multi-Phase Stabilization & Feature Enhancement (P0)**
    - **Description:** This is the main ongoing task, encompassing all points from the user's detailed request in message #495.
    - **Where to resume:**
        1.  Complete the update of  by adding the duplicate item button to the item row.
        2.  Fully update  to use the new  and , and add the Duplicate Item feature.
        3.  Implement the Grid/List view toggle and party name display on  and .
        4.  Proceed to Phase 4 (Final PDF Layout Lock) and Phase 5 (General Quality Controls).
    - **What will be achieved with this?** A stable, mobile-friendly application that meets all of the user's pre-production requirements, ready for final user acceptance testing.
    - **Status:** IN PROGRESS
    - **Should Test frontend/backend/both after fix?** Both. Frontend testing agent is required.
    - **Blocked on something:** None, but highly susceptible to Issue 1.

**Upcoming and Future Tasks**
- **Upcoming Tasks:**
    - **Task 1 (P0):** Finalize PDF Layout Lock (Phase 4). Ensure a clean, consistent, and well-spaced layout across Quotation, PI, and SOA PDFs.
    - **Task 2 (P0):** General Quality Controls (Phase 5). Thoroughly test data consistency between save, preview, and PDF generation to eliminate any stale data issues.
- **Future Tasks:**
    - **Task 1 (P2):** Implement enhanced reporting based on document statuses (e.g., Lead Funnel Report, Quotation Win/Loss Analysis).

**Completed work in this session**
- **User & Data Management:** Updated admin credentials, renamed/removed users, reassigned documents, and cleared/re-imported party/item data from user-provided CSVs.
- **Critical Logic (Phase 1):**
  - Confirmed and locked down the GST calculation logic in the frontend and backend.
  - Implemented a new PDF naming convention with username and timestamp to prevent caching issues.
- **Mobile Usability & UI (Phases 2 & 3):**
  - Created new mobile-first modal components for Party and Item selection (, , etc.).
  - Decoupled the Lead creation form from the Party Master, allowing free-text input.
  - **Partially** implemented the new modals, Duplicate Item feature, and Grid/List view toggle on , , and .
- **Bug Fixes & Enhancements:**
  - Fixed a bug where items were not fully populated when converting documents.
  - Fixed form layout issues where the Party Name overlapped with other fields.
  - Added a missing CSV export endpoint for Items.
  - Implemented N+1 query optimizations in PDF generation and report endpoints.
  - Added new In Process status for Quotations.
  - Implemented a new quotation number format ().
  - Implemented a conditional discount column in PDF item tables.
  - Updated PDF templates with user-requested intro text, terms & conditions, and footers.

**Code Architecture**


**Key Technical Concepts**
- **Backend:** FastAPI, Python, Pymongo, JWT, WeasyPrint.
- **Frontend:** React, Tailwind CSS, shadcn/ui components.
- **Architecture:** Decoupled full-stack application.
- **Environment:** Docker container managed by .

**key DB schema**
- **USER_MASTER:** (user_id, name, email, role, password_hashed)
- **LEADS:** (lead_id, **party_name**, **address**, **contact_person**, **email**, **gst_number**, created_by_user_id, status) *(Note: Decoupled from PARTY_MASTER)*
- **QUOTATIONS / PROFORMA_INVOICE / SOA:** (doc_id, party_id, created_by_user_id, status, items, ...)

**changes in tech stack**
- None.

**All files of reference**
- : Major changes to PDF generation, Lead model, and document creation logic.
- , , : Core forms being heavily modified for mobile usability.
- , , : List pages needing Grid/List toggle implementation.
- : Updated for free-text party fields.
- : Rewritten for mobile.
- : New component.
- , : New components.

**Areas that need refactoring**:
- The three main document form components (, , ) share a large amount of duplicated logic. Once the current feature implementation is stable, this logic could be extracted into a custom hook (e.g., ) to improve maintainability.

**key api endpoints**
- : Generates PDFs for documents (Quotation, PI, SOA, Lead).
- : Exports party data.
- : Exports item data (newly added).
- : Endpoint logic updated to handle free-text party fields.

**Critical Info for New Agent**
- **Top Priority:** You must resume and complete the multi-phase task from user message #495. Start by bringing , , and  to parity with the changes already started on the Quotation pages.
- **WeasyPrint Dependency Crash:** This is a **highly frequent P0 blocker**. If the app is unresponsive or login fails, your first step should always be to check the backend logs for the  error and apply the known fix.
- **Incremental Implementation:** The current task is very large. Focus on completing one phase or sub-task at a time and ensure it works before moving on. The immediate goal is to finish the mobile UI rework (Phase 2) and UI polish (Phase 3).
- **User's Additional Request:** Remember to add the Grid/List view toggle to all document list pages, as confirmed by the user in message #498.

**documents and test reports created in this job**
-  has been updated multiple times.

**Last 10 User Messages and any pending HUMAN messages**
1. **User:** Deploys the app.
2. **Agent:** Confirms readiness for deployment.
3. **User:** Asks to list all users.
4. **Agent:** Lists all 5 users.
5. **User:** Asks to rename one user.
6. **Agent:** Renames the user.
7. **User:** Asks to rename the admin user, reassign all documents to admin, and remove the other 3 sales users.
8. **Agent:** Completes all user management tasks.
9. **User:** Reports login failure for both remaining users.
10. **Agent:** Fixes the recurring backend crash and resets passwords, confirming login now works.
11. **(PENDING) User:** Asks if they should use the preview version or redeploy to test the fixes. Agent correctly advises using the preview version.
12. **(PENDING) User:** Reports that after they redeployed, login is failing again.
13. **(PENDING) User:** Reports that old, deleted users are still appearing in some forms.
14. **(PENDING) User:** Clarifies the issue is on the new quotation form.
15. **(PENDING) User:** Submits a very large, multi-phase pre-production stabilization and feature request (the current main task).
16. **(PENDING) User:** Approves the agent's plan but adds a requirement for a Grid/List view toggle on document list pages.

**Project Health Check:**
- **Broken:** The primary document forms (, ) and list pages (, ) are in an inconsistent, partially-updated state. The mobile usability rework is incomplete.
- **Mocked:** None.

**3rd Party Integrations**
- **WeasyPrint:** Used for PDF generation. Has a fragile and recurring system dependency issue.

**Testing status**
- **Testing agent used after significant changes:** YES (but not for the most recent, in-progress changes).
- **Troubleshoot agent used after agent stuck in loop:** NO
- **Test files created:** None.
- **Known regressions:** The WeasyPrint dependency issue causes the entire backend to fail repeatedly.

**Credentials to test flow:**
- **Admin:** uday.patil@maheshengg.com / admin123
- **Sales User:** surajPatil9995@gmail.com / sales123

**What agent forgot to execute**
- The agent has not forgotten specific instructions but is in the middle of a very large, complex implementation. The key is to ensure the changes (modals, duplicate button, list/grid view) are applied consistently across all three document types (Quotation, PI, SOA) and not just one.</analysis>
